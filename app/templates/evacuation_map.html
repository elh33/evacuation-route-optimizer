<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evacuation Map - Evacuation Route Optimizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        .info-panel {
            max-height: 600px;
            overflow-y: auto;
        }
        .route-option {
            cursor: pointer;
        }
        .route-option:hover {
            background-color: #f8f9fa;
        }
        .route-option.active {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Evacuation Route Optimizer</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/map">Evacuation Map</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">Dashboard</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-md-9">
                <div class="card">
                    <div class="card-body p-2">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Find Evacuation Route</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="startLocation" class="form-label">Starting Point</label>
                            <input type="text" class="form-control" id="startLocation" placeholder="Search or click on map">
                        </div>
                        <div class="mb-3">
                            <label for="endLocation" class="form-label">Destination</label>
                            <input type="text" class="form-control" id="endLocation" placeholder="Search or click on map">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="showAlternatives" checked>
                            <label class="form-check-label" for="showAlternatives">
                                Show alternative routes
                            </label>
                        </div>
                        <button id="findRouteBtn" class="btn btn-primary w-100">Find Route</button>
                        <div id="routeLoadingSpinner" class="spinner-border text-primary d-none mt-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Weather Conditions</h5>
                    </div>
                    <div class="card-body" id="weatherInfo">
                        <p class="text-center">Loading weather data...</p>
                    </div>
                </div>

                <div class="card info-panel">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Route Information</h5>
                    </div>
                    <div class="card-body" id="routeInfo">
                        <p class="text-center">No route selected. Use the form above to find evacuation routes.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white mt-3 py-3">
        <div class="container text-center">
            <p>Real-Time Evacuation Route Optimization System</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([48.8566, 2.3522], 13); // Default to Paris
        let startMarker, endMarker;
        let routeLayers = [];

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Add geocoder control
        const geocoder = L.Control.geocoder({
            defaultMarkGeocode: false
        }).addTo(map);

        // Set event for geocoding results
        geocoder.on('markgeocode', function(e) {
            const latlng = e.geocode.center;
            map.setView(latlng, 16);
        });

        // Initialize city data
        function loadCity() {
            const city = "{{ city }}";
            
            fetch('/api/load_city', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ city: city })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Center map on city
                    map.setView(data.center, 13);
                    
                    // Load weather data
                    loadWeatherData();
                    
                    // Load hazard data and display on map
                    loadHazardData();
                } else {
                    alert('Error loading city data: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading city data. Please try again.');
            });
        }

        // Load weather data
        function loadWeatherData() {
            fetch('/api/weather')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const weather = data.weather;
                    const weatherHTML = `
                        <div class="text-center mb-3">
                            <img src="${weather.icon_url}" alt="${weather.description}" class="img-fluid" style="max-width: 100px;">
                            <h3>${weather.temperature}Â°C</h3>
                            <p>${weather.description}</p>
                        </div>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Humidity <span class="badge bg-primary rounded-pill">${weather.humidity}%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Wind Speed <span class="badge bg-primary rounded-pill">${weather.wind_speed} m/s</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Precipitation <span class="badge bg-primary rounded-pill">${weather.precipitation} mm</span>
                            </li>
                        </ul>
                    `;
                    document.getElementById('weatherInfo').innerHTML = weatherHTML;
                } else {
                    document.getElementById('weatherInfo').innerHTML = '<p class="text-danger">Error loading weather data</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('weatherInfo').innerHTML = '<p class="text-danger">Error loading weather data</p>';
            });
        }

        // Load hazard data
        function loadHazardData() {
            fetch('/api/hazards')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Add hazard polygons to map
                    data.hazards.forEach(hazard => {
                        const color = getHazardColor(hazard.type, hazard.severity);
                        L.polygon(hazard.coordinates, {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.3,
                            weight: 2
                        }).bindTooltip(`${hazard.type} - ${hazard.severity} severity`).addTo(map);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading hazard data:', error);
            });
        }

        // Get color based on hazard type and severity
        function getHazardColor(type, severity) {
            if (type === 'flood') {
                return severity > 0.7 ? '#0000FF' : severity > 0.4 ? '#4444FF' : '#8888FF';
            } else if (type === 'fire') {
                return severity > 0.7 ? '#FF0000' : severity > 0.4 ? '#FF4444' : '#FF8888';
            } else if (type === 'storm') {
                return severity > 0.7 ? '#800080' : severity > 0.4 ? '#994499' : '#BB88BB';
            }
            return '#888888';
        }

        // Handle map clicks for start/end location selection
        map.on('click', function(e) {
            const latlng = e.latlng;
            
            if (!startMarker) {
                // Set start marker
                startMarker = L.marker(latlng, { draggable: true }).addTo(map)
                    .bindTooltip('Start Location').openTooltip();
                document.getElementById('startLocation').value = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
            } else if (!endMarker) {
                // Set end marker
                endMarker = L.marker(latlng, { draggable: true }).addTo(map)
                    .bindTooltip('End Location').openTooltip();
                document.getElementById('endLocation').value = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
            }
        });

        // Find evacuation route
        document.getElementById('findRouteBtn').addEventListener('click', function() {
            const startLocationInput = document.getElementById('startLocation').value;
            const endLocationInput = document.getElementById('endLocation').value;
            const showAlternatives = document.getElementById('showAlternatives').checked;
            
            if (!startLocationInput || !endLocationInput) {
                alert('Please select both start and end locations');
                return;
            }
            
            // Parse coordinates
            let startCoords, endCoords;
            
            try {
                startCoords = parseCoordinates(startLocationInput);
                endCoords = parseCoordinates(endLocationInput);
            } catch (error) {
                alert('Invalid coordinates format. Please use "latitude, longitude" or click on the map.');
                return;
            }
            
            // Show loading spinner
            document.getElementById('routeLoadingSpinner').classList.remove('d-none');
            
            // Clear previous routes
            clearRoutes();
            
            // Request route
            fetch('/api/compute_route', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    start: startCoords,
                    end: endCoords,
                    alternatives: showAlternatives
                })
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading spinner
                document.getElementById('routeLoadingSpinner').classList.add('d-none');
                
                if (data.status === 'success') {
                    // Display routes
                    if (showAlternatives && data.routes) {
                        displayAlternativeRoutes(data.routes);
                    } else if (data.route) {
                        displayRoute(data.route, '#3388ff');
                        displayRouteInfo(data.route);
                    }
                } else {
                    alert('Error finding evacuation route: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('routeLoadingSpinner').classList.add('d-none');
                alert('Error finding evacuation route. Please try again.');
            });
        });

        // Display a single route
        function displayRoute(route, color) {
            const routeLine = L.polyline(route.coordinates, {
                color: color,
                weight: 6,
                opacity: 0.7
            }).addTo(map);
            
            routeLayers.push(routeLine);
            
            // Fit map to the route
            map.fitBounds(routeLine.getBounds());
        }

        // Display alternative routes
        function displayAlternativeRoutes(routes) {
            const colors = ['#3388ff', '#ff3333', '#33ff33'];
            let routeInfoHTML = '<div class="list-group">';
            
            routes.forEach((route, index) => {
                // Display route on map
                displayRoute(route, colors[index % colors.length]);
                
                // Create route info card
                routeInfoHTML += `
                    <a href="#" class="list-group-item list-group-item-action route-option ${index === 0 ? 'active' : ''}" 
                       data-route-id="${index}">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">Route ${index + 1}</h5>
                            <small style="color: ${colors[index % colors.length]};">â </small>
                        </div>
                        <p class="mb-1">Distance: ${(route.distance / 1000).toFixed(2)} km</p>
                        <p class="mb-1">Risk Level: ${getRiskLevelText(route.risk_level)}</p>
                    </a>
                `;
            });
            
            routeInfoHTML += '</div>';
            document.getElementById('routeInfo').innerHTML = routeInfoHTML;
            
            // Add event listeners to route options
            document.querySelectorAll('.route-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Set active class
                    document.querySelectorAll('.route-option').forEach(el => {
                        el.classList.remove('active');
                    </body>
                    });
                    this.classList.add('active');
                    
                    // Display detailed info for the selected route
                    const routeId = this.getAttribute('data-route-id');
                    displayRouteInfo(routes[routeId]);
                });
            });
            
            // Display detailed info for the first route
            displayRouteInfo(routes[0]);
        }

        // Display detailed route information
        function displayRouteInfo(route) {
            const riskLevel = getRiskLevelText(route.risk_level);
            const riskClass = route.risk_level > 0.7 ? 'danger' : 
                             route.risk_level > 0.4 ? 'warning' : 'success';
            
            const distance = (route.distance / 1000).toFixed(2);
            
            // Estimated time calculation (assume average speed of 40 km/h for evacuation)
            const speedKmh = 40;
            const timeHours = distance / speedKmh;
            const timeMinutes = Math.ceil(timeHours * 60);
            
            let infoHTML = `
                <div class="alert alert-${riskClass}">
                    <h5>Risk Level: ${riskLevel}</h5>
                </div>
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Route Details</h5>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Distance <span class="badge bg-primary rounded-pill">${distance} km</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Estimated Time <span class="badge bg-primary rounded-pill">${timeMinutes} min</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Road Conditions <span class="badge bg-${riskClass} rounded-pill">${riskLevel}</span>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Safety Tips</h5>
                        <ul class="list-group">
                            <li class="list-group-item">Stay tuned to emergency broadcasts</li>
                            <li class="list-group-item">Bring essential supplies (water, food, medicine)</li>
                            <li class="list-group-item">Follow instructions from emergency personnel</li>
                            <li class="list-group-item">If possible, travel in groups and maintain communication</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // Only update if we're not showing alternative routes list
            if (!document.querySelector('.route-option')) {
                document.getElementById('routeInfo').innerHTML = infoHTML;
            }
        }

        // Get risk level text based on numerical value
        function getRiskLevelText(riskLevel) {
            if (riskLevel > 0.7) {
                return 'High Risk';
            } else if (riskLevel > 0.4) {
                return 'Medium Risk';
            } else {
                return 'Low Risk';
            }
        }

        // Parse coordinates from string "lat, lng"
        function parseCoordinates(coordStr) {
            const parts = coordStr.split(',').map(part => part.trim());
            if (parts.length !== 2) {
                throw new Error('Invalid coordinates format');
            }
            
            const lat = parseFloat(parts[0]);
            const lng = parseFloat(parts[1]);
            
            if (isNaN(lat) || isNaN(lng)) {
                throw new Error('Invalid coordinates format');
            }
            
            return [lat, lng];
        }

        // Clear all route layers
        function clearRoutes() {
            routeLayers.forEach(layer => {
                map.removeLayer(layer);
            });
            routeLayers = [];
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCity();
        });
    </script>
</body>
</html>